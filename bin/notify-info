#! /bin/bash

(
LOAD=`uptime |sed 's/.*load average/load average/g'`
INFOS=$LOAD
UPGRADE_NUMBER=`apt-get --just-print upgrade|grep -c Inst`
if [ $UPGRADE_NUMBER -ne 0 ] ; then
    INFOS="$INFOS\n‚ùó $UPGRADE_NUMBER mises √† jour"
else
    INFOS="$INFOS\n‚úÖ Pas de mise √† jour"
fi
INFOS="$INFOS\nüåû `brightness current`"
notify-send "‚öôÔ∏è Syst√®me" "$INFOS"  -h string:x-canonical-private-synchronous:system
) &

DATE=`date +"%A %d %B - %H:%M"`

BATTERY_LAPTOP=`upower -i /org/freedesktop/UPower/devices/battery_BAT0|grep percentage|tr -s ' '|cut -d ' ' -f 3`
BATTERY="PC¬†: $BATTERY_LAPTOP"

HEADSET_BLUETOOTH_ADDR=`bluetoothctl devices|grep Bose|cut -d ' ' -f 2`
if [ ! -z "$HEADSET_BLUETOOTH_ADDR" ] ; then
    HEADSET_CONNECTED=`bluetoothctl info $HEADSET_BLUETOOTH_ADDR|grep 'Connected: yes'`
    if [ $? -eq 0 ] ; then
        BATTERY_HEADSET=`based-connect -b $HEADSET_BLUETOOTH_ADDR`
        BATTERY="$BATTERY\nCasque¬†: $BATTERY_HEADSET%"
    fi
fi

MOUSE_DEVICE=`upower -e|grep mouse_dev`
MOUSE_BLUETOOTH_ADDR=`bluetoothctl devices|grep MX|cut -d ' ' -f 2`
if [ ! -z "$MOUSE_BLUETOOTH_ADDR" ] && [ ! -z "$MOUSE_DEVICE" ] ; then
    BATTERY_MOUSE=`upower -i $MOUSE_DEVICE|grep percentage|tr -s ' '|cut -d ' ' -f 3`
    BATTERY="$BATTERY\nSouris¬†: $BATTERY_MOUSE"
fi

SPOTIFY_STATUS="‚ñ∂Ô∏è"
STATUS=`dbus-send --print-reply=literal --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:org.mpris.MediaPlayer2.Player string:PlaybackStatus|grep -i Playing`
if [ $? -ne 0 ] ; then
    SPOTIFY_STATUS="‚è∏Ô∏è"
fi

NETWORK=""
IFS=$'\n'
for DEVICE in `nmcli -g DEVICE,TYPE,STATE,CON-UUID,CONNECTION device|egrep '(ethernet|wifi):connected'` ; do
    TYPE=`echo $DEVICE|cut -d ':' -f 2`
    UUID=`echo $DEVICE|cut -d ':' -f 4`
    if [ "$TYPE" = "wifi" ] ; then
        NAME=`echo $DEVICE|cut -d ':' -f 5-`
    else
        NAME="Ethernet"
    fi
    IP=`nmcli -g ip4.address connection show $UUID|sed 's#/.*##g'`
    NETWORK="$NAME¬†: $IP\n$NETWORK"
done

notify-send "$SPOTIFY_STATUS Spotify" "`cat ~/.last-spotify-notification`"  -h string:x-canonical-private-synchronous:spotify
notify-send "üì° R√©seau" "$NETWORK" -h string:x-canonical-private-synchronous:network
notify-send "‚ö°Ô∏èBatteries" "$BATTERY" -h string:x-canonical-private-synchronous:batteries
notify-send "üóìÔ∏è $DATE" -h string:x-canonical-private-synchronous:datetime
