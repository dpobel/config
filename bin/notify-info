#! /bin/bash

(
LOAD=`uptime |sed 's/.*load average/load average/g'`
INFOS=$LOAD
UPGRADE_NUMBER=`apt-get --just-print upgrade|grep -c Inst`
if [ $UPGRADE_NUMBER -ne 0 ] ; then
    INFOS="$INFOS\n‚ùó $UPGRADE_NUMBER mises √† jour"
else
    INFOS="$INFOS\n‚úÖ Pas de mise √† jour"
fi
notify-send "‚öôÔ∏è Syst√®me" "$INFOS"
) &

DATE=`date +"%A %d %B - %H:%M"`

BATTERY_LAPTOP=`upower -i /org/freedesktop/UPower/devices/battery_BAT0|grep percentage|tr -s ' '|cut -d ' ' -f 3`

MOUSE_DEVICE=`upower -e|grep mouse_dev`

BATTERY="PC¬†: $BATTERY_LAPTOP"
if [ ! -z "$MOUSE_DEVICE" ] ; then
    BATTERY_MOUSE=`upower -i $MOUSE_DEVICE|grep percentage|tr -s ' '|cut -d ' ' -f 3`
    BATTERY="$BATTERY\nSouris¬†: $BATTERY_MOUSE"
fi
# TODO find a way to retrieve Bose battery level‚Ä¶

SPOTIFY_STATUS="‚ñ∂Ô∏è"
STATUS=`dbus-send --print-reply=literal --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:org.mpris.MediaPlayer2.Player string:PlaybackStatus|grep -i Playing`
if [ $? -ne 0 ] ; then
    SPOTIFY_STATUS="‚è∏Ô∏è"
fi

NETWORK=""
IFS=$'\n'
for DEVICE in `nmcli -g DEVICE,TYPE,STATE,CON-UUID,CONNECTION device|egrep '(ethernet|wifi):connected'` ; do
    TYPE=`echo $DEVICE|cut -d ':' -f 2`
    UUID=`echo $DEVICE|cut -d ':' -f 4`
    if [ "$TYPE" = "wifi" ] ; then
        NAME=`echo $DEVICE|cut -d ':' -f 5-`
    else
        NAME="Ethernet"
    fi
    IP=`nmcli -g ip4.address connection show $UUID|sed 's#/.*##g'`
    NETWORK="$NAME¬†: $IP\n$NETWORK"
done

notify-send "$SPOTIFY_STATUS Spotify" "`cat ~/.last-spotify-notification`"
notify-send "üì° R√©seau" "$NETWORK"
notify-send "‚ö°Ô∏èBatteries" "$BATTERY"
notify-send "üóìÔ∏è $DATE"
